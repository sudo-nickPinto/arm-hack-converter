<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<!-- saved from url=(0083)https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
 
 <title>Assignments for CS 221, Fall 2025</title>
 <link rel="stylesheet" href="./hw11_files/generic.css" type="text/css">
</head>


<body class="margin" style="overscroll-behavior-x: auto;">

<div style="text-align: center;">
  <img src="./hw11_files/logo.gif" alt="Gettysburg College"><br>
  <h2>
  CS 221<br>
  Computer Organization and Assembly Language Programming
  </h2>
  Fall 2025<br>

  <hr class="sep">

  <div style="text-align: center ;">
  <h2>Assignment 11</h2>

  <b>Due: Thu, Dec 4, by 11:59pm</b>
  </div>

  <div class="vspace"></div>

</div>


<!--*********** Assignments *************-->



<div>

<h2>Readings</h2>

<!--ul>
<li>Video:
<p />
<ul>
<li><a target="_blank" href="../handouts/eclipse-c++.mp4">Eclipse C++ Setup</a> (3:55-end)</li>
</ul>
<p /></li>
</ul-->

<ul>
<li>Assembler:
<p>
</p><ul>
<li>N2T: Chapter 6 All (slides All)</li>
<li>N2T: Chapter 4 as needed, mostly contained in Chapter 6</li>
<li>ARM Reference: <a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/handouts/ARM_QR.pdf">ARM Quick Reference</a></li>
</ul>
<p></p></li>
</ul>
  
<h2>Description</h2>

This assignment will focus on Assembler and Translator programs. The goal is to build a Translator from ARM Assembly to Hack Assembly.
<p>
Create C++ project called <b><code>ArmToHack</code></b> with files:
</p><p>
</p><ul>
<li><b><code>ArmToHack.h</code></b>: contains class <b><code>ArmToHack</code></b> which has all the Translator functionality</li>
<li><b><code>main.cpp</code></b>: contains the code for creating and executing <code>ArmToHack</code> Translator object.</li>
<li>see Assignment 2 for C++ examples including <code>string</code> and <code>map</code>
</li></ul>

<p>

Download the following files in the project (Right-Click, Save As). Read the comments inside <b><code>token_io.h</code></b> to get familiar with the API:
</p><p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/token_io.h">token_io.h</a> |
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/token_io.cpp">token_io.cpp</a>
</blockquote>

<p>

Make sure to include in your code <code></code> have the relevant includes:
</p><p>
</p><blockquote>
<code>#include &lt;string&gt;</code>
<br>
<code>#include &lt;map&gt;</code>
<br>
<code>#include "token_io.h"</code>
</blockquote>

<p>


</p><h2>Testing</h2>

A number of example programs, named <b><code>programX.arm</code></b>, have been provided for testing the code.
<p>
</p><ul>
<li>inside the project create folder <b><code>test/</code></b> and save the examples there</li>
<li>in <b><code>main</code></b> execute <b><code>.translate("test/programX.arm", "test/programX.asm")</code></b></li>
<li>inspect <b><code>test/programX.asm</code></b> the code to ensure that the translation was done correctly</li>
<li>load <b><code>test/programX.asm</code></b> in CPU Emulator and step through to check that in RAM the cells updated correctly</li>
</ul>

<h2>ArmToHack Translator (No Jump)</h2>

Class <code>ArmToHack</code> will have the following data members:
<p>





</p><table border="1" cellpadding="10">

<tbody><tr valign="middle">
<td>
<code style="color : tomato">const methods and const&amp; params</code>
<p>
</p><div style="padding-left: 4ex;">
Apply <code>const</code> and <code>const&amp;</code> to methods and parameters, respectively, where appropriate.
<p>
Best to leave for the end.
</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">file streams</code>
<p>
</p><div style="padding-left: 4ex;">
File streams for the current input and output programs:
<ul>
<li><code>ifstream</code>: the ARM Assembly input file</li>
<li><code>ofstream</code>: the Hack Assembly output file</li>
</ul>
<p>
Both streams use the same include:
</p><blockquote>
#include <code>&lt;fstream&gt;</code>
</blockquote>
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">line number</code>
<p>
</p><div style="padding-left: 4ex;">
Current line number in Hack program.
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">lookup table 1</code>
<p>
</p><div style="padding-left: 4ex;">
Hash Map for associating registers with their addresses in RAM:
<ul>
<li><code>R0..R15</code> in memory cells <code>0..15</code></li>    
<li><code>FP≡R12, SP≡R13, LR≡R14, PC≡R15</code> in memory cells <code>12..15</code><br>
(special registers have two names that map to the same RAM cell)
</li>
</ul>
<p>
Here is an example that shows how to create a map and check if it has a given key:
</p><p>
</p><blockquote>
C++ Hash Map Example: <a target="_blank" href="https://en.cppreference.com/w/cpp/container/map/contains">https://en.cppreference.com/w/cpp/container/map/contains</a>
</blockquote>
<p>
A map can be constructed directly in the data members section.
</p></div>
</td>
</tr>

</tbody></table>

<p>

Here is the list of required methods:

</p><p>

</p><table border="1" cellpadding="10">

<tbody><tr valign="middle">
<td>
<code style="color : tomato">constructor()</code>
<p>
</p><div style="padding-left: 4ex;">
Any initialization, if necessary (most can be done directly in the data members section). At this point there is nothing to be done with  the two streams.
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">reset()</code>
<p>
</p><div style="padding-left: 4ex;">
Clears the relevant data members in preparation for another translation. Still nothing to be done with the two streams.
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">write_line(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Writes a single complete line of Hack Assembly.
<p>
Important: There should not be any direct writes in the code. All writes to the output should be done by calling this method. (Why? Needs to also do something important that otherwise is easy to overlook.)
</p><p>
Writing to a file stream in C++ is the same as writing to the screen:
</p><blockquote>
<pre style="font-size: 60%;">stream &lt;&lt; ... &lt;&lt; ...;
</pre>
</blockquote>
<p>

</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">void translate(in-filename, out-filename)</code>
<p>
</p><div style="padding-left: 4ex;">
For now mostly calls <code>translateFirstPass</code>.
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">void translateFirstPass(in-filename, out-filename)</code>
<p>
</p><div style="padding-left: 4ex;">
Opens the two streams with the given filenames and carries out the translation.
<p>
At this point there will be no branch instructions.
</p><p>
Skip empty lines and make sure to close the streams.
</p><p>
Here is how to process a file line at a time:
</p><p>
</p><blockquote>
<pre style="font-size: 60%;">myInputStream.open( filename );
while ( myInputStream ) {
    // get a single line from the input
    // do something with the line
}
myInputStream.close();
</pre>
</blockquote>
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">void translate(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Simply dispatches to the relevant translator for the given line.
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">void translateXXX(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Translates the given line, which is an ARM Assembly instruction, to the sequence of Hack Assembly instructions.
<p>  
At this point should support the following using only registers (<code>#N</code> done later):
</p><p>
</p><blockquote>
<code>MOV, ADD, SUB, RSB, CMP, END</code>
</blockquote>
<p>
Note that <code>END</code> involves unconditional jump to the same line. Even though jumps are not supported yet, the code for <code>END</code> can be written, since we know the current line.
</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">testing</code>
<p>
</p><div style="padding-left: 4ex;">
Here are simple test programs:
<p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program1.arm">program1.arm</a> | 
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program2.arm">program2.arm</a> |
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program3.arm">program3.arm</a>
</blockquote>
</div>
</td>
</tr>

</tbody></table>

<p>

</p><h2>ArmToHack Translator (Numeric Constants)</h2>

Add support for numeric constants for any instructions that allow <code>Operand2</code> (see ARM Quick Reference).
<p>
You could consider adding a method <code>write_oper2(token)</code> that writes the corresponding Hack Assembly code to place in <ode>D the value of one of the possible tokens:
</ode></p><p>
</p><blockquote>
<code>Rz, #N, #+N, #-N</code>
</blockquote>
<p>
Recall that the handout code has <code>strip</code> function that can remove a set of characters, and you can use <code>[i]</code> to access a character in C++ string.
</p><p>
Here is a simple test program:
</p><p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program4.arm">program4.arm</a>
</blockquote>
</div>

<p>

</p><h2>ArmToHack Translator (With Back Jumps)</h2>

Add support for basic <i>do-while</i> jumps via the following data members and methods:
<p>
</p><table border="1" cellpadding="10">

<tbody><tr valign="middle">
<td>
<code style="color : tomato">lookup table 2</code>
<p>
</p><div style="padding-left: 4ex;">
Hash Map for associating ARM <code>BXX</code> mnemonics with Hack <code>JXX</code> mnemonics.
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">lookup table 3</code>
<p>
</p><div style="padding-left: 4ex;">
Hash Map for associating ARM labels with their addresses in Hack programs.
<p>
See below for more detailed explanation.
</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">translateJumps(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Translates all <code>BXX</code> commands (ignore <code>BL</code> for now). Our conventions is to emit the value of <code>D</code> register and use that for the jump decision.
<p>
Since we are only handling back jumps the address of the jump is known at the point in the translation process.
</p><p>

</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">translateFirstPass(...)</code>
<p>
</p><div style="padding-left: 4ex;">
Modify this method so that when labels are encountered they are associated with the corresponding line in the Hack program.
<p>
Our convention is that labels are always written on separate lines (only comments allowed). Thus any line that has no second component is considered a label.
</p><p>
(There is one exception to the rule above.)
</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">testing</code>
<p>
</p><div style="padding-left: 4ex;">
Here is a simple test program. Upon completion should see <code>R0=5</code>, <code>R1=15</code>, <code>R2=6</code>.
<p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program5.arm">program5.arm</a>
</blockquote>
</div>
</td>
</tr>

</tbody></table>

<h4>More on new lookup table 3</h4>

Here is the meaning of the new lookup table. Upon reading <code>LABEL</code> in the ARM program, it will have stored <code>map3["LABEL"]=8</code> to indicate that <code>LABEL</code> is associated with <code>ADD</code> which happens to start on line 8 in the Hack program.
<p>
Both ARM programs given below should produce the same Hack program. Blank lines are simply ignored and have no effect.
</p><p>
The line numbers are given only for reference. They are not part of the input/output.
</p><p>
</p><blockquote>
<table cellpadding="10">
<tbody><tr>
<td>
<pre style="font-size: 70%">ARM Code
-----------------
0: MOV Rx, Ry
1: SUB Rx, Rz, Ry
2: LABEL
3: ADD Rx, Ry, Rz
4: CMP Rx, Ry
5: BGT LABEL
</pre>
</td>
<td valign="top" rowspan="2">
<pre style="font-size: 70%">Hack Code
----------------
 0: code for MOV
 1: code for MOV
 2: code for MOV
 3: code for SUB
 4: code for SUB
 5: code for SUB
 6: code for SUB
 7: code for SUB
 8: code for ADD
 9: code for ADD
10: code for ADD
11: code for ADD
12: code for ADD
13: code for CMP
14: code for CMP
15: @8 (go back to ADD)
16: code for BGT
</pre>
</td>
</tr>
<tr>
<td>
<pre style="font-size: 70%">ARM Code
same as above but
with blank  lines
should produce
same Hack code
-----------------
0: MOV Rx, Ry
1:
2: SUB Rx, Rz, Ry
3:
4: LABEL
5:
6: ADD Rx, Ry, Rz
7: CMP Rx, Ry
8:
9: BGT LABEL
</pre>
</td>
</tr>
</tbody></table>
</blockquote>


<h2>ArmToHack Translator (With Full Jumps)</h2>

Add support for full jump functionality via the following data members and methods:
<p>
</p><ul>
<li><code>lookup table 4</code>: Hash Map for associating Hack lines with ARM labels</li>

</ul>

<p>

Here is the meaning of the new map:
</p><p>
</p><blockquote>
<table cellpadding="10">
<tbody><tr>
<td valign="top">
<pre style="font-size: 70%">ARM Code
-----------------
0: MOV Rx, Ry
1: SUB Rx, Rz, Ry
2: CMP Rx, Rz    <b>
3: BEQ LABEL     </b>
4: ADD Rx, Ry, Rz
LABEL            
5: RSB           
</pre>
</td>
<td>
<pre style="font-size: 70%">Hack Code
---------------
0: code for MOV
1: code for MOV
2: code for MOV
3: code for SUB
4: code for SUB
5: code for SUB
6: code for SUB
7: code for SUB
8: code for CMP
9: code for CMP<b>
10: @-1 (unknown address)
11: code for JXX</b>
12: code for ADD
13: code for ADD
14: code for ADD
15: code for ADD
16: code for ADD
17: code for RSB
18: code for RSB
19: code for RSB
20: code for RSB
21: code for RSB
</pre>
</td>
</tr></tbody></table>
</blockquote>

After <code>translateFirstPass</code> the maps will have:
<ul>
<li><code>map3["LABEL"] = 17</code> since <code>RSB</code> starts  at line 17 in the Hack program</li>
<li><code>map4[10] = "LABEL"</code> since line 10 in the Hack program needs to know where to jump to, i.e. needs to know what <code>LABEL</code> corresponds to in the Hack program</li>
</ul>

<p>

</p><table border="1" cellpadding="10">

<tbody><tr valign="middle">
<td>
<code style="color : tomato">translateJumps(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Modified to load <code>A</code> register with the not yet known address of the jump. For now:
<ul>
<li>write the invalid instruction <code>@-1</code></li>
<li>associate the current line in the Hack program with the ARM label</li>
</ul>
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">translateSecondPass(in-filename, out-filename)</code>
<p>
</p><div style="padding-left: 4ex;">
This method simply reads the input file one line at a time and simply prints each line to the output file.
<p>
The only exception are lines whose index appears in the map. The text for these lines will currently be <code>@-1</code> but now we can fix them by getting the correct line number from the other map.
</p><p>
The input file is assumed to be in Hack Assembly, i.e the partially created final output.
</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">void translate(in-filename, out-filename)</code>
<p>
</p><div style="padding-left: 4ex;">
Modify this method to do the following:
<p>
</p><blockquote>
<pre>translateFirstPass(in-filename, tmp-filename)
translateSecondPass(tmp-filename, out-filename)
</pre>
</blockquote>
<p>
Here <code>tmp-filename</code> is <code>in-filename</code> with the added suffix <code>".tmp"</code>
</p></div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">testing</code>
<p>
</p><div style="padding-left: 4ex;">
Here is a simple test program.  It is the same as <code>program5.arm</code> but uses a <i>while loop</i>, so should see same values in RAM.
<p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program6.arm">program6.arm</a>
</blockquote>
</div>
</td>
</tr>

</tbody></table>

<p>

</p><h2>ArmToHack Translator (Jumps Misc.)</h2>

Make the necessary updates to handle the following:

<p>

</p><table border="1" cellpadding="10">

<tbody><tr valign="middle">
<td>
<code style="color : tomato">void translateJumps(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Handles <code>BL</code> which is a jump that also stores the address of the next instruction in <code>LR</code>.
<p>
Here is a simple test program. It is the same as <code>program6.arm</code> but should also see a value in <code>LR</code> that corresponds to the address where <code>END</code> begins.
</p><p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program7.arm">program7.arm</a>
</blockquote>
</div>
</td>
</tr>

<tr valign="middle">
<td>
<code style="color : tomato">void translateXXX(line)</code>
<p>
</p><div style="padding-left: 4ex;">
Update any ARM instruction that has destination register to handle writing to <code>PC</code>.
<p>
These instructions proceed as before but if the destination register is <code>PC</code>-equivalent, a jump is carried to the value of <code>PC</code>.
</p><p>
Consider adding method <code>write_pcjump(regRd)</code>. If the given register is <code>PC</code>-equivalent, writes the relevant instructions; otherwise does nothing. The modifications the existing code should be fairly minimal.
</p><p>
</p><p>
Here are sample test programs. The programs should jump back and forth and conclude with <code>R0=1</code> in RAM.
</p><p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program8.arm">program8.arm</a> |
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program9.arm">program9.arm</a> | edit for other cases
</blockquote>
</div>
</td>
</tr>

</tbody></table>

<h2>Final Test</h2>

Convert the following program and execute it on the Computer. The program adds the values computed during the iteration of the <a target="_blank" href="https://en.wikipedia.org/wiki/Collatz_conjecture">3n+1 problem</a>.
<p>
When the program is done, should see <code>R5=518</code>.
</p><p>
Upload a screenshot named <b>3n1.png</b> of Hardware Simulator / CPU Emulator that shows the contents of the RAM
</p><p>
</p><blockquote>
<a target="_blank" href="https://www.cs.gettysburg.edu/~ilinkin/courses/Fall-2025/cs221/assignments/a11-files/program10.arm">program10.arm</a>
</blockquote>



<p>

</p><hr class="sep">

<div>
<h2>What to turn in</h2>

Upload <code>ArmToHack.h</code>, <code>main.cpp</code>, <code>3n1.png</code> to the Moodle dropbox.

</div>



</body></html>